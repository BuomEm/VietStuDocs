# Set PHP Timezone to Vietnam (UTC+7)
php_value date.timezone "Asia/Ho_Chi_Minh"
php_value session.gc_maxlifetime 604800
php_value session.cookie_lifetime 604800

RewriteEngine On

# 1. Redirect .php to extensionless (Redirect public URL)
# For specific files in /page folder
RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s/page/(contact|dashboard|edit-document|error|faq|history|login|logout|premium|privacy|profile|saved|shop|search|signup|sitemap|terms|transaction-details|upload|user_profile|view)\.php [NC]
RewriteRule ^page/(.*)\.php$ /%1 [R=301,L]

# For remaining root files (like index.php)
RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s/(index|testapi)\.php [NC]
RewriteRule ^ /%1 [R=301,L]

# For tutors directory files
RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s/tutors/(apply|dashboard|profile_edit|request|withdraw)\.php [NC]
RewriteRule ^ /tutors/%1 [R=301,L]

# 2. Rewrite extensionless to .php (Internal handling)
# Handle pages moved to /page directory
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(contact|dashboard|edit-document|error|faq|history|login|logout|premium|privacy|profile|saved|shop|search|signup|sitemap|terms|transaction-details|upload|user_profile|view)$ page/$1.php [L]

# Handle root files
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(index|testapi)$ $1.php [L]

# 2.1 API Folder Handling (Case-Insensitive & Extensionless)
# Handle /api/ or /API/ calls
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(api|API)/(.*)$ API/$2 [NC,PT]

# Handle extensionless files in API folder
RewriteCond %{REQUEST_URI} ^/(api|API)/ [NC]
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(api|API)/(.*)$ API/$2.php [NC,L]

# For Admin directory
RewriteCond %{REQUEST_URI} ^/admin/
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^admin/(.*)$ admin/$1.php [L]

# For Tutors directory
RewriteCond %{REQUEST_URI} ^/tutors/
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^tutors/(.*)$ tutors/$1.php [L]

# 3. Handle index.php redirect (Hide index.php)
RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s(.*)/index\.php [NC]
RewriteRule ^ %1/ [R=301,L]

# Error Pages
ErrorDocument 400 /page/error.php?code=400
ErrorDocument 401 /page/error.php?code=401
ErrorDocument 403 /page/error.php?code=403
ErrorDocument 404 /page/error.php?code=404
ErrorDocument 500 /page/error.php?code=500


# Protect Sensitive Files
<FilesMatch "^(\.env|\.git|composer\.lock|composer\.json)">
    Order allow,deny
    Deny from all
</FilesMatch>

<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresDefault "access plus 1 month"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
</IfModule>

# Add MIME types for fonts
<IfModule mod_mime.c>
  AddType font/woff .woff
  AddType font/woff2 .woff2
</IfModule>


# Enable Gzip compression
<IfModule mod_deflate.c>
  # Compress HTML, CSS, JavaScript, Text, XML and fonts
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
  AddOutputFilterByType DEFLATE application/x-font
  AddOutputFilterByType DEFLATE application/x-font-opentype
  AddOutputFilterByType DEFLATE application/x-font-otf
  AddOutputFilterByType DEFLATE application/x-font-truetype
  AddOutputFilterByType DEFLATE application/x-font-ttf
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE font/opentype
  AddOutputFilterByType DEFLATE font/otf
  AddOutputFilterByType DEFLATE font/ttf
  AddOutputFilterByType DEFLATE font/woff
  AddOutputFilterByType DEFLATE font/woff2
  AddOutputFilterByType DEFLATE image/svg+xml
  AddOutputFilterByType DEFLATE image/x-icon
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/xml

  # Remove browser bugs (only needed for really old browsers)
  BrowserMatch ^Mozilla/4 gzip-only-text/html
  BrowserMatch ^Mozilla/4\.0[678] no-gzip
  BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
  Header append Vary User-Agent
</IfModule>

# Block access to protected directories
<IfModule mod_rewrite.c>
    RewriteRule ^includes/ - [F,L]
    RewriteRule ^config/ - [F,L]
    RewriteRule ^database/ - [F,L]
    RewriteRule ^AAA/ - [F,L]
</IfModule>
